name: Update CLIProxyAPI Version

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to update (empty = all)'
        required: false
        type: choice
        options:
          - ''
          - 'cliproxyapi'
          - 'cliproxyapi-plus'
          - 'cliproxyapi-business'
      version:
        description: 'Specific version (only used with specific edition)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for updates
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_EDITION: ${{ inputs.edition }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          # Edition-to-repo mapping (must match update-version.sh)
          declare -A REPOS=(
              ["cliproxyapi"]="router-for-me/CLIProxyAPI"
              ["cliproxyapi-plus"]="router-for-me/CLIProxyAPIPlus"
              ["cliproxyapi-business"]="router-for-me/CLIProxyAPIBusiness"
          )

          # Collect updates into array
          updates=()

          # Determine which editions to check
          if [ -n "$INPUT_EDITION" ]; then
            editions_to_check=("$INPUT_EDITION")
          else
            editions_to_check=("cliproxyapi" "cliproxyapi-plus" "cliproxyapi-business")
          fi

          for edition in "${editions_to_check[@]}"; do
            repo="${REPOS[$edition]}"

            echo "Checking $edition ($repo)..."

            # Extract current version from flake.nix using perl multiline match
            # The /s modifier allows . to match newlines
            current_version=$(perl -0ne 'print $1 if /'"$edition"' = \{[^}]*?version = "([^"]+)"/s' flake.nix)

            if [ -z "$current_version" ]; then
              echo "Warning: Could not extract version for $edition, skipping"
              continue
            fi

            echo "  Current version: $current_version"

            # Determine target version
            if [ -n "$INPUT_EDITION" ] && [ -n "$INPUT_VERSION" ]; then
              # Use specified version for specific edition
              new_version="$INPUT_VERSION"
            else
              # Fetch latest from GitHub API with authentication
              new_version=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$repo/releases/latest" | \
                jq -r '.tag_name' | sed 's/^v//')
            fi

            if [ -z "$new_version" ]; then
              echo "Warning: Could not fetch latest version for $edition, skipping"
              continue
            fi

            echo "  Latest version: $new_version"

            # Check if update is needed
            if [ "$current_version" != "$new_version" ]; then
              echo "  Update needed: $current_version -> $new_version"
              updates+=("{\"edition\":\"$edition\",\"new_version\":\"$new_version\",\"current_version\":\"$current_version\",\"repo\":\"$repo\"}")
            else
              echo "  Already at latest version"
            fi
          done

          # Build JSON matrix output
          if [ ${#updates[@]} -eq 0 ]; then
            matrix='{"include":[]}'
          else
            # Join updates with commas and wrap in include array
            updates_json=$(IFS=,; echo "${updates[*]}")
            matrix="{\"include\":[$updates_json]}"
          fi

          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo ""
          echo "Matrix output: $matrix"

  update-edition:
    needs: check-updates
    if: fromJson(needs.check-updates.outputs.matrix).include[0] != null
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.check-updates.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update version and hashes
        run: |
          chmod +x scripts/update-version.sh
          ./scripts/update-version.sh "${{ matrix.edition }}" "${{ matrix.new_version }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ matrix.edition }} to v${{ matrix.new_version }}"
          title: "chore: update ${{ matrix.edition }} to v${{ matrix.new_version }}"
          body: |
            Automated update of ${{ matrix.edition }} from v${{ matrix.current_version }} to v${{ matrix.new_version }}.

            **Release notes:** https://github.com/${{ matrix.repo }}/releases/tag/v${{ matrix.new_version }}

            ---
            *This PR was automatically created by the update workflow.*
          branch: update/${{ matrix.edition }}-${{ matrix.new_version }}
          delete-branch: true
          labels: |
            automated
            dependencies
